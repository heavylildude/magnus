"use strict";function decodeHtmlEntities(str){const textarea=document.createElement("textarea");textarea.innerHTML=str;return textarea.value}function extractDiffsAndText(content){const diffs=[];let textParts=[];let lastIndex=0;const magnusDiffRegex=/<magnus-diff\s+filepath=["']([^"']+)["'][^>]*>\s*([\s\S]*?)\s*<\/magnus-diff>/gi;let match;console.log("[MAGNUS] Scanning for magnus-diff tags in response...");while((match=magnusDiffRegex.exec(content))!==null){const filePath=match[1];let diffContent=match[2].trim();diffContent=decodeHtmlEntities(diffContent);diffContent=diffContent.replace(/^```diff\s*\n?/gm,"").replace(/\n?```\s*$/gm,"");console.log("[MAGNUS] Found magnus-diff for:",filePath);console.log("[MAGNUS] Diff content preview:",diffContent.substring(0,200));textParts.push(content.substring(lastIndex,match.index));diffs.push({filePath:filePath,diffContent:diffContent});lastIndex=match.index+match[0].length}textParts.push(content.substring(lastIndex));let text=textParts.join("").trim();text=text.replace(/^-+\s*(File|PDF):\s*[^\n]+-+\s*\n?/gm,"");text=text.replace(/^\s*\n/,"");const maskedContent=content.replace(magnusDiffRegex,match=>match.replace(/./g," "));const markdownRegex=/```(\w*)\s*\n([\s\S]*?)```/gi;let mdMatch;while((mdMatch=markdownRegex.exec(maskedContent))!==null){const originalMatch=content.substring(mdMatch.index,mdMatch.index+mdMatch[0].length);const innerContent=originalMatch.match(/```(\w*)\s*\n([\s\S]*?)```/i);if(!innerContent)continue;const lang=innerContent[1].toLowerCase();let codeBlock=innerContent[2].trim();codeBlock=codeBlock.replace(/^-+\s*(File|PDF):\s*[^\n]+-+\s*\n?/gm,"").trim();let filePath="generated-code.txt";if(activeFileIndex>=0&&activeFileIndex<openFiles.length){filePath=openFiles[activeFileIndex].relativePath}else if(selectedContextFiles.length>0){filePath=selectedContextFiles[0].relativePath}else if(chatHistory.length>0){const lastUserMsg=[...chatHistory].reverse().find(msg=>msg.role==="user");if(lastUserMsg){const fileMatch=lastUserMsg.content.match(/File:\s*([^\n]+)|@([\w\-\.\/]+)/);if(fileMatch){filePath=fileMatch[1]||fileMatch[2]}}}text=text.replace(originalMatch,"");const isDiff=lang==="diff"||codeBlock.startsWith("diff --git")||codeBlock.includes("@@")&&(codeBlock.includes(" +")||codeBlock.includes(" -"));if(isDiff){diffs.push({filePath:filePath,diffContent:codeBlock})}else{diffs.push({filePath:filePath,newContent:codeBlock})}}console.log("[MAGNUS] Extraction complete. Found",diffs.length,"code blocks/diffs");return{text:text.trim(),diffs:diffs}}function formatDiff(diff){if(!diff){console.warn("[MAGNUS] formatDiff called with undefined/null diff");return'<span class="diff-line">No diff content available</span>'}return diff.split("\n").map(line=>{const esc=escapeHtml(line);if(line.startsWith("+")&&!line.startsWith("+++")){return`<span class="diff-line added">+ ${esc.slice(1)}</span>`}else if(line.startsWith("-")&&!line.startsWith("---")){return`<span class="diff-line removed">- ${esc.slice(1)}</span>`}else if(line.startsWith("@@")){return`<span class="diff-line hunk">${esc}</span>`}return`<span class="diff-line">${esc}</span>`}).join("\n")}function goToCodeLocation(filePath,diffContent){const normalizedTarget=filePath.trim().replace(/\\/g,"/");let fileIndex=openFiles.findIndex(f=>{const fPath=f.relativePath.replace(/\\/g,"/");return fPath===normalizedTarget||fPath.endsWith("/"+normalizedTarget)});if(fileIndex===-1){alert(`File ${filePath} is not open. Please open it first to jump to code.`);return}setActiveFile(fileIndex);const hunkRegex=/^@@ -(\d+)(?:,(\d+))? \+(\d+)(?:,(\d+))? @@/m;const match=diffContent.match(hunkRegex);if(match){const startLine=parseInt(match[1],10);const length=parseInt(match[2]||"1",10);editor.setSelection({line:startLine-1,ch:0},{line:startLine-1+length,ch:0});editor.scrollIntoView({line:startLine-1,ch:0},200);editor.focus()}else{alert("Could not determine line number from diff.")}}function createCodeCard({filePath:filePath,diffContent:diffContent,newContent:newContent}){const actionId="action-"+Date.now()+"-"+Math.random();codeActions.set(actionId,{filePath:filePath,diff:diffContent,newContent:newContent});const section=document.createElement("div");section.className="code-section";const hasHunks=diffContent&&diffContent.match(/^@@ -(\d+)/m);const canGoTo=!newContent&&hasHunks;const isLazyDiff=!newContent&&diffContent&&!hasHunks;section.innerHTML=`\n        <div class="code-section-header">\n            <div class="code-section-title">\n                <span class="code-section-toggle">▶</span>\n                <span class="code-section-file">${escapeHtml(filePath)}</span>\n                <span class="code-section-lang">${newContent?"CODE":"DIFF"}</span>\n                ${isLazyDiff?'<span class="code-warning" title="Missing line numbers (@@ ... @@). Auto-apply might fail.">⚠️ Lazy Diff</span>':""}\n            </div>\n            <div class="code-section-header-actions" style="display: flex; gap: 5px;">\n                ${canGoTo?'<button class="code-btn small goto-btn" title="Go to code location">Go To</button>':""}\n                <button class="code-btn small insert-btn" title="Insert at cursor">Insert</button>\n                <button class="code-btn small copy-btn" title="Copy">COPY</button>\n            </div>\n        </div>\n        <div class="code-section-body">\n            <pre class="code-section-content">${newContent?escapeHtml(newContent):formatDiff(diffContent)}</pre>\n            <div class="code-section-actions">\n                <button class="code-btn close-btn">Reject</button>\n                <button class="code-btn inject-btn" ${isLazyDiff?'style="opacity: 0.6; cursor: not-allowed;" title="Cannot auto-apply without line numbers. Use Insert."':""}>Apply</button>\n            </div>\n        </div>\n    `;const header=section.querySelector(".code-section-header");const body=section.querySelector(".code-section-body");const toggle=section.querySelector(".code-section-toggle");header.onclick=e=>{if(e.target.tagName==="BUTTON")return;body.classList.toggle("collapsed");toggle.classList.toggle("collapsed");toggle.textContent=body.classList.contains("collapsed")?"▶":"▶"};section.querySelector(".copy-btn").onclick=()=>{const contentToCopy=newContent||diffContent;navigator.clipboard.writeText(contentToCopy);updateStatus("Copied to clipboard!")};const goToBtn=section.querySelector(".goto-btn");if(goToBtn){goToBtn.onclick=()=>{goToCodeLocation(filePath,diffContent)}}section.querySelector(".insert-btn").onclick=()=>{insertCodeManually(actionId,section)};section.querySelector(".inject-btn").onclick=()=>{if(isLazyDiff){alert('⚠️ This diff is missing line numbers (@@ ... @@).\n\nMagnus cannot auto-apply it safely. Please use the "Insert" button to place the code manually.');return}applyCodeAction(actionId,section)};section.querySelector(".close-btn").onclick=()=>{const actionsDiv=section.querySelector(".code-section-actions");if(actionsDiv){actionsDiv.innerHTML='<span style="color: #888; font-style: italic;">Rejected</span>'}codeActions.delete(actionId)};return section}function finalizeMessageInChat(messageId,fullContent){const messageDiv=document.getElementById(messageId);if(!messageDiv)return;const contentDiv=messageDiv.querySelector(".message-content");const{text:text,diffs:diffs}=extractDiffsAndText(fullContent);if(text.trim()){contentDiv.innerHTML=text.replace(/\n/g,"<br>")}else{contentDiv.innerHTML=""}diffs.forEach(diff=>{const card=createCodeCard(diff);messageDiv.appendChild(card)});const container=document.getElementById("chatMessages");container.scrollTop=container.scrollHeight}async function insertCodeManually(actionId,sectionElement){const action=codeActions.get(actionId);if(!action)return;let{diff:diff,newContent:newContent}=action;let contentToInsert=newContent;if(!contentToInsert&&diff){if(typeof diff==="string"){contentToInsert=diff.split("\n").filter(line=>line.startsWith("+")&&!line.startsWith("+++")).map(line=>line.substring(1)).join("\n")}else{console.error("[MAGNUS] diff is not a string:",typeof diff,diff)}}if(!contentToInsert){alert("No content to insert found (only added lines are inserted from diffs).");return}const activeFile=openFiles[activeFileIndex];if(!activeFile){alert("Please open a file in the editor first.");return}try{if(lastCursorPosition){editor.setCursor(lastCursorPosition)}editor.replaceSelection(contentToInsert);activeFile.content=editor.getValue();activeFile.unsaved=true;lastCursorPosition=editor.getCursor();editor.focus();renderTabs();updateSaveButton();updateStatus(`Inserted code ✔`);const actionsDiv=sectionElement.querySelector(".code-section-actions");if(actionsDiv){actionsDiv.innerHTML='<span style="color: #4caf50; font-style: italic;">Inserted</span>'}}catch(err){console.error("Manual insert failed:",err);alert(`Couldn't insert code: ${err.message}`)}}async function applyCodeAction(actionId,sectionElement){const action=codeActions.get(actionId);if(!action)return;const{filePath:filePath,diff:diff,newContent:newContent}=action;const normalizedTarget=filePath.trim().replace(/\\/g,"/");const findFileInTree=(tree,path)=>{for(const item of tree){const itemPath=item.relativePath.replace(/\\/g,"/");if(item.type==="file"&&(itemPath===path||itemPath.endsWith("/"+path))){return item}if(item.type==="folder"&&item.children){const found=findFileInTree(item.children,path);if(found)return found}}return null};try{showLoader();let fileIndex=openFiles.findIndex(f=>{const fPath=f.relativePath.replace(/\\/g,"/");const tPath=normalizedTarget;return fPath===tPath||fPath.endsWith("/"+tPath)||tPath.endsWith("/"+fPath)});if(fileIndex===-1){const fileItem=findFileInTree(fileTree,normalizedTarget);if(fileItem){await openFile(fileItem);fileIndex=openFiles.findIndex(f=>{const fPath=f.relativePath.replace(/\\/g,"/");return fPath===normalizedTarget})}}if(fileIndex===-1){hideLoader();if(!confirm(`File "${filePath}" not found. Create new file?`)){return}showLoader();const response=await fetch("/api/apply-patch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({originalContent:"",change:newContent?{type:"replace",newContent:newContent}:{type:"diff",diffContent:diff}})});if(!response.ok){const errData=await response.json();hideLoader();alert(`Failed to create file: ${errData.error}`);return}const result=await response.json();const newFileName=filePath.split("/").pop();openFiles.push({handle:null,relativePath:filePath,name:newFileName,content:result.patchedContent,unsaved:true,originalContent:null,isNew:true,type:"text"});setActiveFile(openFiles.length-1);updateStatus(`Created & applied: ${filePath} ✔`);hideLoader();return}const currentContent=openFiles[fileIndex].content;const response=await fetch("/api/apply-patch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({originalContent:currentContent,change:newContent?{type:"replace",newContent:newContent}:{type:"diff",diffContent:diff}})});if(!response.ok){const errData=await response.json();hideLoader();alert(`Patch failed: ${errData.error}`);return}const result=await response.json();const patchedContent=result.patchedContent;openFiles[fileIndex].content=patchedContent;openFiles[fileIndex].unsaved=true;if(fileIndex===activeFileIndex){const cursor=editor.getCursor();editor.setValue(patchedContent);editor.setCursor(cursor)}renderTabs();renderFileTree();updateSaveButton();updateStatus(`Applied changes to ${filePath} ✔`);hideLoader();const actionsDiv=sectionElement.querySelector(".code-section-actions");if(actionsDiv){actionsDiv.innerHTML='<span style="color: #4caf50; font-style: italic;">Applied</span>'}}catch(err){hideLoader();console.error("Patch failed:",err);alert(`Couldn't apply patch to ${filePath}. Check console.`)}codeActions.delete(actionId)}