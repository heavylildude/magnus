"use strict";async function addContextFile(file){const exists=selectedContextFiles.find(f=>f.relativePath===file.relativePath);if(!exists){if(!file.content){try{if(file.file){file.content=await file.file.text()}else if(file.handle){const fileData=await file.handle.getFile();file.content=await fileData.text()}else{console.error("[MAGNUS] File has no content, file object, or handle:",file);alert(`Can't load file: ${file.relativePath} - no file handle available`);return}}catch(err){console.error("[MAGNUS] Failed to load context file:",err);alert(`Couldn't load file: ${file.relativePath}`);return}}selectedContextFiles.push(file);renderContextTags()}closeContextSearch()}function removeContextFile(relativePath){selectedContextFiles=selectedContextFiles.filter(f=>f.relativePath!==relativePath);renderContextTags()}function openContextSearch(){const container=document.getElementById("contextSearchContainer");if(container.style.display=="block"){isContextSearchOpen=false;document.getElementById("contextSearchContainer").style.display="none";document.getElementById("contextSearchDropdown").style.display="none"}else{isContextSearchOpen=true;container.style.display="block";const searchInput=document.getElementById("contextSearchInput");searchInput.value="";searchInput.focus();const dropdown=document.getElementById("contextSearchDropdown");dropdown.style.display="block";renderContextOptions("")}}function closeContextSearch(){isContextSearchOpen=false;document.getElementById("contextSearchContainer").style.display="none";document.getElementById("contextSearchDropdown").style.display="none"}function getAllFilesFromTree(tree){let files=[];tree.forEach(item=>{if(item.type==="file"){files.push(item)}else if(item.children){files=files.concat(getAllFilesFromTree(item.children))}});return files}function renderContextTags(){const container=document.getElementById("contextTags");container.innerHTML="";selectedContextFiles.forEach(file=>{const tag=document.createElement("div");tag.className="context-tag";const icon=file.type==="pdf"?"◳":"▣";tag.innerHTML=`\n            <span>${icon} ${file.name}</span>\n            <button class="remove-context" title="Remove">X</button>\n        `;tag.querySelector(".remove-context").onclick=()=>removeContextFile(file.relativePath);container.appendChild(tag)})}function renderContextOptions(filter){const dropdown=document.getElementById("contextSearchDropdown");dropdown.innerHTML="";let allFiles=[];if(fileTree&&fileTree.length>0){allFiles=getAllFilesFromTree(fileTree)}if(openFiles&&openFiles.length>0){openFiles.forEach(f=>{if(!allFiles.find(a=>a.relativePath===f.relativePath)){allFiles.push(f)}})}const filtered=allFiles.filter(f=>{const isSelected=selectedContextFiles.find(s=>s.relativePath===f.relativePath);const matchesFilter=!filter||f.name.toLowerCase().includes(filter.toLowerCase())||f.relativePath.toLowerCase().includes(filter.toLowerCase());return matchesFilter&&!isSelected});if(filtered.length===0){dropdown.innerHTML='<div class="context-option-empty">No files found</div>';return}filtered.slice(0,10).forEach(file=>{const option=document.createElement("div");option.className="context-option";const icon=file.type==="pdf"?"◳":"▣";option.innerHTML=`<span>${icon} ${file.relativePath}</span>`;option.onclick=()=>addContextFile(file);dropdown.appendChild(option)})}