"use strict";function detectUserIntent(message){if(!message)return{isAnalysis:false,isModification:false};const analysisPatterns=/^(summarize|explain|what|how|analyze|describe|tell me|review|check|read|show me|list|find|give me|get|why|compare|difference|summary|overview|breakdown)/i;const codeModPatterns=/^(create|write|generate|build|fix|refactor|optimize|improve|change|modify|update|replace|rewrite|add|remove|delete|implement|debug|enhance)/i;const isAnalysis=analysisPatterns.test(message)&&!codeModPatterns.test(message);const isModification=codeModPatterns.test(message);return{isAnalysis:isAnalysis,isModification:isModification}}async function checkOllamaHealth(){try{const response=await fetch("/api/ollama-health");const data=await response.json();isOllamaConnected=data.status==="connected";const dot=document.getElementById("ollamaStatusDot");const text=document.getElementById("ollamaStatusText");if(isOllamaConnected){dot.classList.add("connected");if(data.source==="gemini"){currentProvider="Gemini";text.textContent="Connected";dot.style.backgroundColor="#4285F4"}else{currentProvider="Ollama";text.textContent="Connected";dot.style.backgroundColor="#00ff00"}}else{currentProvider="AI";dot.classList.remove("connected");text.textContent="Disconnected";dot.style.backgroundColor="var(--status-offline)"}}catch(error){isOllamaConnected=false;currentProvider="AI";document.getElementById("ollamaStatusDot").classList.remove("connected");document.getElementById("ollamaStatusText").textContent="Error"}}function getLastSearchContext(){for(let i=chatHistory.length-1;i>=0;i--){const msg=chatHistory[i];if(msg.role==="assistant"&&msg.content.includes("Found results for:")){const match=msg.content.match(/Found results for:\s*"([^"]+)"/);if(match)return match[1]}if(msg.role==="user"){const searchMatch=msg.content.match(/^\/websearch\s+(.+)$/i)||msg.content.match(/search\s+(?:online|the\s+web)\s+(?:for\s+)?(.+)/i)||msg.content.match(/look\s+(?:up|online)\s+(?:for\s+)?(.+)/i);if(searchMatch)return searchMatch[1].trim()}}return null}function resolveContextualReferences(message){const lastSearch=getLastSearchContext();if(!lastSearch)return message;let resolved=message.replace(/\b(about|for|on|regarding)\s+it\b/gi,`$1 "${lastSearch}"`).replace(/\bsearch\s+(?:for\s+)?it\b/gi,`search online for "${lastSearch}"`).replace(/\bgimme?\s+(?:a\s+)?summary\s+(?:of\s+)?it\b/gi,`gimme summary of "${lastSearch}"`).replace(/\bmore\s+(?:info|details)\s+(?:about|on)\s+it\b/gi,`more info about "${lastSearch}"`);return resolved}function detectWebSearchIntent(message){if(!message)return null;const commandMatch=message.match(/^\/websearch\s+(.+)$/i);if(commandMatch){return{intent:true,query:commandMatch[1].trim(),method:"command"}}const patterns=[/search\s+(?:online|the\s+web|google)\s+(?:for\s+)?(.+)/i,/look\s+(?:up|online)\s+(?:for\s+)?(.+)/i,/lookup\s+(?:online\s+)?(?:for\s+)?(.+)/i,/(?:can\s+you\s+)?lookup\s+(?:online\s+)?(?:for\s+)?(.+)/i,/(?:can\s+you\s+)?search\s+(?:online|the\s+web)\s+(?:for\s+)?(.+)/i,/find\s+(?:online\s+)?(?:information\s+)?(?:about\s+)?(.+)/i,/what's?\s+(?:the\s+)?(?:latest|new|recent)\s+(.+)/i,/(?:any\s+)?(?:recent|new)\s+(?:info|news)\s+(?:about|on)\s+(.+)/i];for(const pattern of patterns){const match=message.match(pattern);if(match){return{intent:true,query:match[1].trim(),method:"natural"}}}return null}async function performWebSearch(query){try{const response=await fetch("/api/websearch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:query})});if(!response.ok){const err=await response.json();throw new Error(err.error)}const data=await response.json();return data.results}catch(error){console.error("Web search error:",error);return`Search error: ${error.message}`}}async function saveToMemory(role,content){try{await fetch("/api/memory/add",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({role:role,content:content,metadata:{timestamp:(new Date).toISOString()}})})}catch(error){console.error("Failed to save to memory:",error)}}function addMessageToChat(role,content){const container=document.getElementById("chatMessages");if(!hasChatStarted){container.innerHTML="";hasChatStarted=true}const messageId="msg-"+Date.now()+"-"+Math.random();const messageDiv=document.createElement("div");messageDiv.className=`chat-message ${role}`;messageDiv.id=messageId;messageDiv.setAttribute("data-raw-content",content);const contentDiv=document.createElement("div");contentDiv.className="message-content";contentDiv.textContent=content;messageDiv.appendChild(contentDiv);container.appendChild(messageDiv);container.scrollTop=container.scrollHeight;return messageId}function updateMessageInChat(messageId,content){const messageDiv=document.getElementById(messageId);if(!messageDiv)return;messageDiv.setAttribute("data-raw-content",content);const contentDiv=messageDiv.querySelector(".message-content");if(contentDiv){contentDiv.innerHTML=escapeHtml(content).replace(/\n/g,"<br>")}const container=document.getElementById("chatMessages");container.scrollTop=container.scrollHeight}async function sendChatMessage(){if(!isOllamaConnected){alert(`${currentProvider} is not connected. Check your connection and settings.`);return}let input=document.getElementById("chatInput");let message=input.value.trim();if(!message)return;const{isAnalysis:isAnalysis,isModification:isModification}=detectUserIntent(message);const resolvedMessage=resolveContextualReferences(message);await saveToMemory("user",message);addMessageToChat("user",message);input.value="";chatHistory.push({role:"user",content:message});const searchIntent=detectWebSearchIntent(resolvedMessage);let searchResults=null;let enhancedPrompt=resolvedMessage;if(searchIntent&&searchIntent.intent){const searchLoadingId=addMessageToChat("assistant","üîç Searching online...");try{searchResults=await performWebSearch(searchIntent.query);updateMessageInChat(searchLoadingId,`üîç‚úì Found info for: "${searchIntent.query}". Analyzing...`);const searchString=Array.isArray(searchResults)?searchResults.map((r,i)=>`${i+1}. **${r.title}**\n${r.description}\nURL: ${r.url}`).join("\n\n"):searchResults;enhancedPrompt=`### Context\nThe user performed a web search for: "${searchIntent.query}"\n\n### Search Results\n${searchString}\n\n### Instruction\nBased ONLY on the search results above, answer the user's question: "${message}". \nProvide a clear, natural language summary of the information found. Do not repeat the search results list verbatim.`;chatHistory[chatHistory.length-1].searchQuery=searchIntent.query}catch(error){updateMessageInChat(searchLoadingId,`‚ùå Search failed: ${error.message}`)}}const loadingId=addMessageToChat("assistant","*thinking...*");try{let prompt=enhancedPrompt;let intentInstruction="";if(isAnalysis){intentInstruction="\n\n[USER INTENT: Analysis Request]\n[RESPONSE INSTRUCTION: The user wants an explanation or summary. Provide a detailed text response. DO NOT generate code changes or diffs.]"}else if(isModification){intentInstruction='\n\n[USER INTENT: Code Modification Request]\n[RESPONSE INSTRUCTION: The user wants to change the code. You MUST provide changes using the <magnus-diff filepath="..."> format. Output the tag directly with diff content inside - NO markdown fences, NO CDATA wrapper.]'}if(selectedContextFiles.length>0){prompt+="\n\nContext Files:";selectedContextFiles.forEach(file=>{const prefix=file.type==="pdf"?`PDF: ${file.relativePath}`:`File: ${file.relativePath}`;prompt+=`\n\n--- ${prefix} ---\n${file.content}`})}else if(activeFileIndex>=0){const file=openFiles[activeFileIndex];const prefix=file.type==="pdf"?`PDF: ${file.relativePath}`:`File: ${file.relativePath}`;prompt+=`\n\n--- ${prefix} ---\n${file.content}`}prompt+=intentInstruction;const payload={messages:[{role:"user",content:prompt}],includeMemory:true};const response=await fetch("/api/ollama-chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});if(!response.ok)throw new Error("Chat request failed");const reader=response.body.getReader();const decoder=new TextDecoder;let fullResponse="";while(true){const{value:value,done:done}=await reader.read();if(done)break;const chunk=decoder.decode(value);const lines=chunk.split("\n");for(const line of lines){if(line.startsWith("data: ")){const data=line.slice(6);if(data==="[DONE]")break;try{const parsed=JSON.parse(data);if(parsed.message?.content){fullResponse+=parsed.message.content;updateMessageInChat(loadingId,fullResponse)}}catch(e){}}}}await saveToMemory("assistant",fullResponse);chatHistory.push({role:"assistant",content:fullResponse});if(typeof finalizeMessageInChat==="function"){finalizeMessageInChat(loadingId,fullResponse,searchResults)}else{console.error("finalizeMessageInChat is not defined. Check script loading order.")}}catch(error){console.error("Chat error:",error);updateMessageInChat(loadingId,"‚ùå Error: "+error.message)}}function clearChat(){if(!confirm("Clear chat history? This will also clear active memory."))return;chatHistory=[];codeActions.clear();hasChatStarted=false;document.getElementById("chatMessages").innerHTML=`\n        <div class="placeholder" style="padding: 20px; text-align: center; color: var(--text-secondary); font-size: 12px;">\n            Start chatting about your code...\n        </div>\n    `;fetch("/api/memory/clear",{method:"POST"}).catch(err=>console.error("Failed to clear memory:",err))}