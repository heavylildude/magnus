"use strict";const SUPPORTED_FORMATS=["text","code","pdf","docx","xlsx","xls"];const DOCUMENT_MIMETYPES={"application/vnd.openxmlformats-officedocument.wordprocessingml.document":"docx","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":"xlsx","application/vnd.ms-excel":"xls","application/pdf":"pdf"};function getFileType(filename,mimetype=""){const ext=filename.split(".").pop().toLowerCase();if(DOCUMENT_MIMETYPES[mimetype]){return DOCUMENT_MIMETYPES[mimetype]}if(ext==="docx"||ext==="doc")return"docx";if(ext==="xlsx"||ext==="xls")return"xlsx";if(ext==="pdf")return"pdf";return"text"}async function openFileDialog(){try{showLoader();const[fileHandle]=await window.showOpenFilePicker({multiple:false});const file=await fileHandle.getFile();const fileType=getFileType(file.name,file.type);if(["pdf","docx","xlsx"].includes(fileType)){await handleDocumentFile(file,fileHandle);hideLoader();return}const content=await file.text();const existingIndex=openFiles.findIndex(f=>f.handle===fileHandle);if(existingIndex!==-1){setActiveFile(existingIndex);hideLoader();return}openFiles.push({handle:fileHandle,relativePath:fileHandle.name,name:fileHandle.name,content:content,unsaved:false,originalContent:content,type:"text",isNew:false});setActiveFile(openFiles.length-1);updateStatus(`Opened ${fileHandle.name}`);hideLoader()}catch(error){hideLoader();if(error.name!=="AbortError"){console.error("Error opening file:",error);updateStatus("Failed to open file",true)}}}async function handleDocumentFile(file,fileHandle){try{showLoader();const formData=new FormData;formData.append("file",file);const response=await fetch("/api/upload-file",{method:"POST",body:formData});if(!response.ok){const err=await response.json();throw new Error(err.error)}const data=await response.json();const fileType=getFileType(file.name,file.type);const existingIndex=openFiles.findIndex(f=>f.name===file.name);if(existingIndex!==-1){setActiveFile(existingIndex);hideLoader();return}if(data.isLarge){console.warn("⚠️ Document is large:",data.warning)}openFiles.push({handle:fileHandle,relativePath:file.name,name:file.name,fileId:data.fileId,content:data.content,originalContent:null,unsaved:false,type:fileType,tokenCount:data.tokenCount,isLarge:data.isLarge,warning:data.warning,file:file});setActiveFile(openFiles.length-1);updateStatus(`Loaded ${fileType.toUpperCase()}: ${file.name}${data.isLarge?" ⚠️ Large file":""}`);hideLoader()}catch(error){hideLoader();console.error("Document handling error:",error);updateStatus(`Failed to load document: ${error.message}`,true)}}async function openFolderDialog(){try{showLoader();directoryHandle=await window.showDirectoryPicker();projectRoot=directoryHandle.name;fileTree=await processDirectoryHandle(directoryHandle);renderFileTree();updateStatus(`Loaded project: ${projectRoot}`);hideLoader()}catch(error){hideLoader();if(error.name!=="AbortError"){console.error("Error opening directory:",error);updateStatus("Failed to open directory",true)}}}async function handleDrop(event){event.preventDefault();event.stopPropagation();showLoader();const items=event.dataTransfer.items;if(!items){hideLoader();return}for(let i=0;i<items.length;i++){const item=items[i];if(item.kind==="file"){const entry=item.webkitGetAsEntry?.();if(entry?.isDirectory){try{const tree=await traverseDirectoryEntry(entry);if(tree.length>0){directoryHandle=null;projectRoot=entry.name;fileTree=tree;renderFileTree();updateStatus(`Loaded project: ${projectRoot}`);hideLoader();return}}catch(err){console.error("Directory traversal failed:",err)}}}}for(let i=0;i<items.length;i++){const item=items[i];if(item.kind==="file"){const file=item.getAsFile();if(!file)continue;const fileType=getFileType(file.name,file.type);if(["pdf","docx","xlsx"].includes(fileType)){await handleDocumentFile(file,null);continue}const existingIndex=openFiles.findIndex(f=>f.name===file.name);if(existingIndex!==-1){setActiveFile(existingIndex);continue}const content=await file.text();openFiles.push({handle:null,relativePath:file.name,name:file.name,content:content,unsaved:false,originalContent:content,file:file,isNew:false,type:"text"});setActiveFile(openFiles.length-1);updateStatus(`Opened ${file.name}`)}}hideLoader()}async function traverseDirectoryEntry(entry,path=""){const tree=[];try{const reader=entry.createReader();const entries=await new Promise((resolve,reject)=>{reader.readEntries(resolve,reject)});for(const childEntry of entries){const entryPath=path?`${path}/${childEntry.name}`:childEntry.name;if(childEntry.isFile){const file=await new Promise((resolve,reject)=>{childEntry.file(resolve,reject)});tree.push({name:childEntry.name,type:"file",handle:null,relativePath:entryPath,file:file})}else if(childEntry.isDirectory){const children=await traverseDirectoryEntry(childEntry,entryPath);tree.push({name:childEntry.name,type:"folder",handle:null,relativePath:entryPath,children:children})}}}catch(err){console.error("Error reading directory entry:",err)}return tree.sort((a,b)=>{if(a.type===b.type)return a.name.localeCompare(b.name);return a.type==="folder"?-1:1})}async function openFile(fileItem){const fileType=getFileType(fileItem.name,fileItem.file?.type||"");if(["pdf","docx","xlsx"].includes(fileType)){if(fileItem.file){await handleDocumentFile(fileItem.file,fileItem.handle)}return}showLoader();let content;try{if(fileItem.file){content=await fileItem.file.text()}else if(fileItem.handle){const file=await fileItem.handle.getFile();content=await file.text()}else{hideLoader();return}const existingIndex=openFiles.findIndex(f=>f.relativePath===fileItem.relativePath);if(existingIndex!==-1){setActiveFile(existingIndex);hideLoader();return}openFiles.push({handle:fileItem.handle,relativePath:fileItem.relativePath,isNew:false,name:fileItem.name,content:content,unsaved:false,originalContent:content,file:fileItem.file,type:"text"});setActiveFile(openFiles.length-1);updateStatus(`Opened ${fileItem.name}`);hideLoader()}catch(error){hideLoader();console.error("Error opening file:",error);updateStatus(`Failed to open ${fileItem.name}`,true)}}async function processDirectoryHandle(dirHandle,path=""){const tree=[];for await(const entry of dirHandle.values()){const entryPath=path?`${path}/${entry.name}`:entry.name;if(entry.kind==="file"){tree.push({name:entry.name,type:"file",handle:entry,relativePath:entryPath})}else if(entry.kind==="directory"){tree.push({name:entry.name,type:"folder",handle:entry,relativePath:entryPath,children:await processDirectoryHandle(entry,entryPath)})}}return tree.sort((a,b)=>{if(a.type===b.type)return a.name.localeCompare(b.name);return a.type==="folder"?-1:1})}function createNewFile(){const newFileName=`Untitled-${untitledCounter++}`;openFiles.push({handle:null,relativePath:newFileName,name:newFileName,content:"",unsaved:true,originalContent:null,isNew:true,type:"text"});setActiveFile(openFiles.length-1);updateStatus(`Created new file: ${newFileName}`)}async function saveCurrentFile(){if(activeFileIndex<0)return;const file=openFiles[activeFileIndex];if(["pdf","docx","xlsx"].includes(file.type)){updateStatus("Cannot save document files",true);return}file.content=editor.getValue();try{showLoader();let fileHandle=file.handle;if(!fileHandle||file.isNew){fileHandle=await window.showSaveFilePicker({suggestedName:file.name});file.handle=fileHandle;file.name=fileHandle.name;file.relativePath=fileHandle.name}const writable=await fileHandle.createWritable();await writable.write(file.content);await writable.close();file.unsaved=false;file.originalContent=file.content;file.isNew=false;renderTabs();renderFileTree();updateSaveButton();updateStatus(`Saved ${file.name}`);hideLoader()}catch(error){hideLoader();console.error("Error saving file:",error);updateStatus(`Failed to save ${file.name}`,true)}}async function saveAllFiles(){const unsavedFiles=openFiles.filter(f=>f.unsaved&&!["pdf","docx","xlsx"].includes(f.type));if(unsavedFiles.length===0){updateStatus("No unsaved files");return}showLoader();for(const file of unsavedFiles){if(!file.handle)continue;try{const writable=await file.handle.createWritable();await writable.write(file.content);await writable.close();file.unsaved=false;file.originalContent=file.content}catch(error){console.error(`Error saving ${file.name}:`,error)}}renderTabs();renderFileTree();updateSaveButton();updateStatus(`Saved ${unsavedFiles.length} file(s)`);hideLoader()}