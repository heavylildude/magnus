"use strict";function renderFileTree(){const container=document.getElementById("fileTree");container.innerHTML="";if(!fileTree||fileTree.length===0){container.innerHTML='<div style="padding: 20px; text-align: center; color: var(--text-secondary); font-size: 12px;">No folder opened</div>';return}fileTree.forEach(item=>{container.appendChild(createTreeItem(item))})}function createTreeItem(item,level=0){const div=document.createElement("div");const itemKey=`${projectRoot}/${item.relativePath}`;const isCollapsed=treeItemStates.get(itemKey)||false;if(item.type==="folder"){const folderItem=document.createElement("div");folderItem.className="tree-item folder";folderItem.style.paddingLeft=level*16+8+"px";folderItem.innerHTML=`\n            <span class="icon">${isCollapsed?"▶":"▼"}</span>\n            <span class="name">${item.name}</span>\n        `;const childrenContainer=document.createElement("div");childrenContainer.className=isCollapsed?"tree-children collapsed":"tree-children";if(item.children){item.children.forEach(child=>{childrenContainer.appendChild(createTreeItem(child,level+1))})}folderItem.onclick=()=>{const wasCollapsed=childrenContainer.classList.contains("collapsed");childrenContainer.classList.toggle("collapsed");folderItem.querySelector(".icon").textContent=wasCollapsed?"▼":"▶";treeItemStates.set(itemKey,!wasCollapsed)};div.appendChild(folderItem);div.appendChild(childrenContainer)}else{const fileItem=document.createElement("div");fileItem.className="tree-item";fileItem.style.paddingLeft=level*16+8+"px";const foundOpenFile=openFiles.find(f=>f.relativePath===item.relativePath);const isUnsaved=foundOpenFile&&foundOpenFile.unsaved;const isActive=activeFileIndex>=0&&openFiles[activeFileIndex]?.relativePath===item.relativePath;if(isActive)fileItem.classList.add("active");let icon="◳";const name=item.name.toLowerCase();if(name.endsWith(".docx")||name.endsWith(".doc"))icon="◳";else if(name.endsWith(".xlsx")||name.endsWith(".xls"))icon="◳";else if(name.endsWith(".pdf"))icon="◳";else if(name.endsWith(".js")||name.endsWith(".ts"))icon="◳";else if(name.endsWith(".html")||name.endsWith(".css"))icon="◳";else if(name.endsWith(".py"))icon="◳";else if(name.endsWith(".md"))icon="◳";fileItem.innerHTML=`\n            <span class="icon">${icon}</span>\n            <span class="name">${item.name}</span>\n            ${isUnsaved?'<span class="unsaved">◯</span>':""}\n        `;fileItem.onclick=()=>openFile(item);div.appendChild(fileItem)}return div}function setActiveFile(index){if(index<0||index>=openFiles.length)return;activeFileIndex=index;const file=openFiles[index];console.log("setActiveFile - file type:",file.type,"name:",file.name);if(file.type==="pdf"){renderPdfViewer(file)}else if(file.type==="docx"){renderDocxViewer(file)}else if(file.type==="xlsx"||file.type==="xls"){renderExcelViewer(file)}else{renderCodeEditor(file)}renderTabs();renderFileTree();updateStatusBar();updateSaveButton();updateFocusedTabIndicator()}function renderCodeEditor(file){const changeHandler=editor.getOption("onChange");editor.setOption("onChange",null);editor.setValue(file.content||"");editor.setOption("onChange",changeHandler);editor.on("change",handleEditorChange);editor.setOption("readOnly",false);editor.setOption("mode",getMode(file.name));const cmElement=document.querySelector(".CodeMirror");if(cmElement){cmElement.style.display="block"}document.getElementById("pdfViewer").style.display="none";document.getElementById("documentViewer").style.display="none"}function renderPdfViewer(file){editor.setOption("readOnly",true);const cmElement=document.querySelector(".CodeMirror");if(cmElement){cmElement.style.display="none"}const pdfViewer=document.getElementById("pdfViewer");if(!pdfViewer){console.error("pdfViewer div not found in DOM!");return}document.getElementById("documentViewer").style.display="none";if(!file.fileId){pdfViewer.innerHTML=`<div style="padding: 20px; color: red;">Error: No fileId for PDF</div>`;return}const iframeHtml=`<iframe src="/api/file/${file.fileId}" style="width: 100%; height: 100%; border: none; display: block;"></iframe>`;pdfViewer.style.display="block";pdfViewer.innerHTML=iframeHtml}async function renderDocxViewer(file){editor.setOption("readOnly",true);const cmElement=document.querySelector(".CodeMirror");if(cmElement){cmElement.style.display="none"}const pdfViewer=document.getElementById("pdfViewer");if(pdfViewer){pdfViewer.style.display="none"}const docViewer=document.getElementById("documentViewer");if(!docViewer){console.error("documentViewer div not found in DOM!");return}docViewer.style.display="block";docViewer.innerHTML=`\n        <div class="document-viewer">\n            <div class="document-header">\n                <span class="doc-icon"></span>\n                <span class="doc-name">${escapeHtml(file.name)}</span>\n                <span class="doc-meta">${file.tokenCount||0} tokens</span>\n                ${file.isLarge?'<span class="doc-warning">(!) Large file</span>':""}\n            </div>\n            <div id="docPreview" class="docx-preview-container"></div>\n        </div>\n    `;try{if(!file.fileId){throw new Error("No fileId for DOCX")}if(!window.docx){throw new Error("docx-preview library not loaded")}const response=await fetch(`/api/file/${file.fileId}`);if(!response.ok){throw new Error(`Failed to fetch DOCX: ${response.statusText}`)}const arrayBuffer=await response.arrayBuffer();const container=document.getElementById("docPreview");if(!container){throw new Error("docPreview container not found")}await window.docx.renderAsync(new Uint8Array(arrayBuffer),container,null,{className:"docx-rendered",inWrapper:true,breakPages:false})}catch(error){console.error("Error rendering DOCX:",error);const container=document.getElementById("docPreview");if(container){container.innerHTML=`\n                <div style="color: var(--nano-warning); padding: 10px; border: 1px solid var(--nano-warning);">\n                    <strong>⚠️ Failed to render formatting:</strong> ${escapeHtml(error.message)}\n                    <br><br>\n                    <strong>Fallback - Extracted text:</strong>\n                    <pre style="background: var(--nano-bg); padding: 8px; margin-top: 8px; border-radius: 2px; overflow-x: auto;">${escapeHtml(file.content)}</pre>\n                </div>\n            `}}}function renderExcelViewer(file){editor.setOption("readOnly",true);const cmElement=document.querySelector(".CodeMirror");if(cmElement){cmElement.style.display="none"}const pdfViewer=document.getElementById("pdfViewer");if(pdfViewer){pdfViewer.style.display="none"}const docViewer=document.getElementById("documentViewer");if(!docViewer){console.error("documentViewer div not found in DOM!");return}docViewer.style.display="block";docViewer.innerHTML=`\n        <div class="document-viewer">\n            <div class="document-header">\n                <span class="doc-icon"></span>\n                <span class="doc-name">${escapeHtml(file.name)}</span>\n                <span class="doc-meta">${file.tokenCount||0} tokens</span>\n                ${file.isLarge?'<span class="doc-warning">(!) Large file</span>':""}\n            </div>\n            <pre class="document-content">${escapeHtml(file.content)}</pre>\n        </div>\n    `}function renderTabs(){const container=document.getElementById("editorTabs");container.innerHTML="";openFiles.forEach((file,index)=>{const tab=document.createElement("div");tab.className="editor-tab"+(index===activeFileIndex?" active":"");let icon="";if(file.type==="docx")icon="";else if(file.type==="xlsx"||file.type==="xls")icon="";else if(file.type==="pdf")icon="";tab.innerHTML=`\n            <span>${icon} ${file.name}</span>\n            ${file.unsaved?'<span style="color: var(--warning);">●</span>':""}\n            <span class="close">×</span>\n        `;const closeBtn=tab.querySelector(".close");closeBtn.onclick=e=>{e.stopPropagation();closeFile(index)};tab.onclick=()=>{setActiveFile(index)};container.appendChild(tab)});updateFocusedTabIndicator()}function updateFocusedTabIndicator(){const indicator=document.getElementById("focusedTabIndicator");if(!indicator)return;if(activeFileIndex>=0&&activeFileIndex<openFiles.length){const file=openFiles[activeFileIndex];let displayPath=file.name;if(file.handle&&!file.isNew&&file.relativePath!==file.name){displayPath=file.relativePath}indicator.textContent=`[ ${displayPath} ]`}else{indicator.textContent="No tab in focus."}}function closeFile(index){const file=openFiles[index];if(file.unsaved){if(!confirm(`Close ${file.name} without saving changes?`)){return}}if(file.fileId){fetch(`/api/delete-file/${file.fileId}`,{method:"POST"}).catch(err=>console.error("Failed to delete file:",err))}openFiles.splice(index,1);if(index===activeFileIndex){if(openFiles.length>0){setActiveFile(Math.max(0,index-1))}else{activeFileIndex=-1;editor.setValue("");editor.setOption("readOnly",true);document.getElementById("pdfViewer").innerHTML="";document.getElementById("pdfViewer").style.display="none";document.getElementById("documentViewer").innerHTML="";document.getElementById("documentViewer").style.display="none";renderTabs();renderFileTree()}}else if(index<activeFileIndex){activeFileIndex--}renderTabs();renderFileTree();updateSaveButton();updateStatus(``)}function updateStatusBar(){if(!editor)return;const cursor=editor.getCursor();document.getElementById("statusRight").textContent=`Ln ${cursor.line+1}, Col ${cursor.ch+1}`}function updateSaveButton(){const hasUnsaved=openFiles.some(f=>f.unsaved);const currentUnsaved=activeFileIndex>=0&&openFiles[activeFileIndex]?.unsaved;document.getElementById("saveFile").disabled=!currentUnsaved;document.getElementById("saveAllFiles").disabled=!hasUnsaved}