const{fetch:fetch}=require("undici");class WebSearch{constructor(config={}){this.braveApiKey=config.braveApiKey||null;this.googleApiKey=config.googleApiKey||null;this.googleCxId=config.googleCxId||null;this.timeout=config.timeout||8e3}static detectSearchIntent(message){if(!message)return null;const commandMatch=message.match(/^\/websearch\s+(.+)$/i);if(commandMatch){return{intent:true,query:commandMatch[1].trim(),method:"command"}}const patterns=[/search\s+(?:online|the\s+web|google)\s+(?:for\s+)?(.+)/i,/look\s+(?:up|online)\s+(?:for\s+)?(.+)/i,/lookup\s+(?:online\s+)?(?:for\s+)?(.+)/i,/(?:can\s+you\s+)?lookup\s+(?:online\s+)?(?:for\s+)?(.+)/i,/(?:can\s+you\s+)?search\s+(?:online|the\s+web)\s+(?:for\s+)?(.+)/i,/find\s+(?:online\s+)?(?:information\s+)?(?:about\s+)?(.+)/i,/what's?\s+(?:the\s+)?(?:latest|new|recent)\s+(.+)/i,/(?:any\s+)?(?:recent|new)\s+(?:info|news)\s+(?:about|on)\s+(.+)/i];for(const pattern of patterns){const match=message.match(pattern);if(match){return{intent:true,query:match[1].trim(),method:"natural"}}}return null}async search(query){if(!query||query.trim()===""){return[]}const enhancedQuery=this.enhanceQueryWithDate(query);console.log(`ðŸ” Web search triggered for: "${query}"`);if(enhancedQuery!==query){console.log(`ðŸ” Enhanced query: "${enhancedQuery}"`)}try{if(this.braveApiKey){try{const results=await this.searchWithBrave(enhancedQuery);if(results&&results.length>0){return results}}catch(err){console.warn(`Brave search failed: ${err.message}`)}}if(this.googleApiKey&&this.googleCxId){try{const results=await this.searchWithGoogle(enhancedQuery);if(results&&results.length>0){return results}}catch(err){console.warn(`Google search failed: ${err.message}`)}}return[]}catch(error){console.error("Search orchestration error:",error);throw error}}enhanceQueryWithDate(query){const lowerQuery=query.toLowerCase();const needsDate=/\b(latest|today|current|now|recent|this\s+week|this\s+month)\b/i.test(lowerQuery);if(!needsDate){return query}const now=new Date;const dateStr=now.toISOString().split("T")[0];const monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"];const readableDate=`${monthNames[now.getMonth()]} ${now.getDate()}, ${now.getFullYear()}`;return`${query} ${readableDate}`}async searchWithBrave(query){const url=`https://api.search.brave.com/res/v1/web/search?q=${encodeURIComponent(query)}&count=5`;try{const response=await fetch(url,{method:"GET",headers:{"X-Subscription-Token":this.braveApiKey,Accept:"application/json"},timeout:this.timeout});if(!response.ok){throw new Error(`Brave API returned ${response.status}`)}const data=await response.json();if(!data.web||!data.web.results||data.web.results.length===0){return[]}return data.web.results.slice(0,5).map(result=>({title:result.title,description:result.description,url:result.url}))}catch(error){throw new Error(`Brave search failed: ${error.message}`)}}async searchWithGoogle(query){const url=`https://www.googleapis.com/customsearch/v1?key=${this.googleApiKey}&cx=${this.googleCxId}&q=${encodeURIComponent(query)}&num=5`;try{const response=await fetch(url,{method:"GET",headers:{Accept:"application/json"},timeout:this.timeout});if(!response.ok){throw new Error(`Google API returned ${response.status}`)}const data=await response.json();if(!data.items||data.items.length===0){return[]}return data.items.slice(0,5).map(item=>({title:item.title,description:item.snippet,url:item.link}))}catch(error){throw new Error(`Google search failed: ${error.message}`)}}isConfigured(){return!!(this.braveApiKey||this.googleApiKey&&this.googleCxId)}getStatus(){return{braveConfigured:!!this.braveApiKey,googleConfigured:!!(this.googleApiKey&&this.googleCxId),ready:this.isConfigured()}}}module.exports=WebSearch;