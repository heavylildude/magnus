const express=require("express");const fs=require("fs").promises;const path=require("path");const cors=require("cors");const{fetch:fetch}=require("undici");const{GoogleGenAI:GoogleGenAI}=require("@google/genai");const SmartInjector=require("./modules/smart-injector");const multer=require("multer");const mammoth=require("mammoth");const XLSX=require("xlsx");const PDFParser=require("pdf2json");const ActiveMemory=require("./modules/activememory");const WebSearch=require("./modules/websearch");require("dotenv").config();console.log("DEBUG: GEMINI_API_KEY loaded:",!!process.env.GEMINI_API_KEY);if(process.env.GEMINI_API_KEY){console.log("DEBUG: GEMINI_API_KEY length:",process.env.GEMINI_API_KEY.length);console.log("DEBUG: GEMINI_API_KEY first 4 chars:",process.env.GEMINI_API_KEY.substring(0,4))}else{console.log("DEBUG: GEMINI_API_KEY is missing or empty")}const app=express();const PORT=6969;const upload=multer({storage:multer.memoryStorage(),limits:{fileSize:100*1024*1024}});let date_time=new Date;let date=("0"+date_time.getDate()).slice(-2);let month=("0"+(date_time.getMonth()+1)).slice(-2);let year=date_time.getFullYear();let curdate=year+"-"+month+"-"+date;const fileStorage=new Map;const memoryConfig={maxHistoryMessages:process.env.MAX_HISTORY||15,contextTurns:process.env.CONTEXT_TURNS||7};const searchConfig={braveApiKey:process.env.BRAVE_API_KEY||null,googleApiKey:process.env.GOOGLE_API_KEY||null,googleCxId:process.env.GOOGLE_CX_ID||null,timeout:8e3};const activeMemory=new ActiveMemory("database/magnus_memory.sqlite3",memoryConfig);const webSearch=new WebSearch(searchConfig);const settings={model:process.env.MODEL,contextWindow:32768,systemPrompt:`You are MAGNUS, a gnarly code assistant.\n\n# CORE INSTRUCTION FLOW\n\n## Step 1: Detect User Intent\n- **ANALYSIS REQUEST**: User asks to "explain", "summarize", "review", "what is", "how does", "analyze", "describe"\n- **CODE MODIFICATION**: User asks to "fix", "change", "refactor", "add", "remove", "update", "modify", "create"\n\n## Step 2: Response Format Rules\n\n### FOR ANALYSIS REQUESTS:\n- Provide a clear text explanation\n- You MAY include small code snippets in markdown blocks for illustration\n- DO NOT generate full file diffs\n\n### FOR CODE MODIFICATION REQUESTS:\nYou MUST use the magnus-diff format. Follow this EXACT structure:\n\n<magnus-diff filepath="path/to/file.ext">\n--- a/path/to/file.ext\n+++ b/path/to/file.ext\n@@ -10,5 +10,5 @@\n context line\n-old code to remove\n+new code to add\n context line\n</magnus-diff>\n\n**CRITICAL RULES FOR MAGNUS-DIFF:**\n1. Output the <magnus-diff> tag DIRECTLY - NO markdown fences around it\n2. NO CDATA wrapper - just put the diff content directly inside the tags\n3. The filepath attribute MUST match the file being modified\n4. Use standard unified diff format (--- a/... +++ b/... @@ ... @@)\n5. **EXAMINE THE ACTUAL FILE CONTENT** - You will receive the file content in the prompt\n6. **GENERATE ACCURATE LINE NUMBERS** - The @@ hunk header MUST reference real line numbers from the file\n7. Include at least 3 lines of ACTUAL context from the file before and after changes\n8. DO NOT output the entire file - ONLY the changed sections\n9. **NEVER use @@ -0,0 +1,X @@** - This means "empty file", which is WRONG if you're modifying existing code\n\n**HOW TO GENERATE THE @@ HUNK HEADER:**\n- Format: @@ -oldStart,oldCount +newStart,newCount @@\n- oldStart = line number in original file where changes start\n- oldCount = number of lines in the original section (including context)\n- newStart = line number in new file where changes start (usually same as oldStart)\n- newCount = number of lines in the new section (including context)\n- Example: @@ -15,7 +15,8 @@ means "starting at line 15, replacing 7 lines with 8 lines"\n\n**CORRECT EXAMPLE (Modifying existing file):**\n<magnus-diff filepath="server.js">\n--- a/server.js\n+++ b/server.js\n@@ -50,7 +50,7 @@\n const app = express();\n-const PORT = 3000;\n+const PORT = 6969;\n \n app.use(cors());\n</magnus-diff>\n\n**WRONG - DO NOT DO THIS:**\n<magnus-diff filepath="test.html">\n--- a/test.html\n+++ b/test.html\n@@ -0,0 +1,8 @@\n+<!DOCTYPE html>\n+<html>\n...\n</magnus-diff>\n‚òùÔ∏è This is WRONG because @@ -0,0 means "empty file" but you're modifying an existing file!\n\n**CORRECT WAY (if replacing entire <head> section starting at line 3):**\n<magnus-diff filepath="test.html">\n--- a/test.html\n+++ b/test.html\n@@ -3,5 +3,5 @@\n <head>\n-    <meta charset="UTF-8">\n-    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n-    <title>Badass Login Page</title>\n+    <meta charset="UTF-8">\n+    <title>Document</title>\n </head>\n</magnus-diff>\n\n### FOR NEW FILES:\nIf creating a brand new file (not modifying existing), use a markdown code block:\n\n\`\`\`javascript\n// new file content here\n\`\`\`\n\n## Additional Info\n- Current date: ${curdate}\n- You're a cheeky Aussie surfer bro, keep it casual and fun`};app.use(cors());app.use(express.json({limit:"150mb"}));async function parsePdfContent(buffer){return new Promise((resolve,reject)=>{const pdfParser=new PDFParser(this,1);pdfParser.on("pdfParser_dataError",errData=>{console.error("PDF parse error:",errData.parserError);reject(new Error("Error parsing PDF: Could not extract text."))});pdfParser.on("pdfParser_dataReady",pdfData=>{try{console.log("[PDF DEBUG] pdfData structure:",JSON.stringify(pdfData,null,2).substring(0,500));const pages=pdfData.Pages||pdfData.formImage&&pdfData.formImage.Pages||[];console.log("[PDF DEBUG] Number of pages:",pages.length);const fullText=pages.map((page,i)=>{const pageText=page.Texts.map(text=>{try{return decodeURIComponent(text.R.map(r=>r.T).join(""))}catch(e){console.log("[PDF DEBUG] URI decode failed, using raw text:",e.message);return text.R.map(r=>r.T).join("")}}).join(" ");console.log(`[PDF DEBUG] Page ${i+1} text length:`,pageText.length);return`\n--- Page ${i+1} ---\n`+pageText}).join("\n");console.log("[PDF DEBUG] Total extracted text length:",fullText.length);console.log("[PDF DEBUG] First 200 chars:",fullText.substring(0,200));resolve(fullText.trim()||"[PDF appears to be empty or contains only images]")}catch(error){console.error("PDF extraction error:",error);resolve("[Error extracting PDF text]")}});pdfParser.parseBuffer(buffer)})}async function parseDocxContent(buffer){try{const result=await mammoth.extractRawText({buffer:buffer});return result.value||""}catch(error){console.error("DOCX parse error:",error);return`[Error parsing DOCX: ${error.message}]`}}async function parseExcelContent(buffer){try{const workbook=XLSX.read(buffer,{type:"buffer"});let fullContent="";workbook.SheetNames.forEach(sheetName=>{fullContent+=`--- Sheet: ${sheetName} ---\n`;const csv=XLSX.utils.sheet_to_csv(workbook.Sheets[sheetName]);fullContent+=csv+"\n\n"});return fullContent||"[Empty Excel file]"}catch(error){console.error("XLSX parse error:",error);return`[Error parsing XLSX: ${error.message}]`}}function estimateTokens(text){const words=text.split(/\s+/).length;return Math.ceil(words/.75)}app.get("/api/settings",(req,res)=>{res.json({model:settings.model,contextWindow:settings.contextWindow,systemPrompt:settings.systemPrompt})});app.get("/api/health",(req,res)=>{res.json({status:"ok",memory:{messageCount:activeMemory.getMessageCount(),maxHistory:memoryConfig.maxHistoryMessages,contextTurns:memoryConfig.contextTurns},webSearch:webSearch.getStatus()})});app.get("/api/ollama-health",async(req,res)=>{if(process.env.GEMINI_API_KEY&&process.env.GEMINI_API_KEY.trim()!==""){return res.json({status:"connected",models:[{name:"gemini-2.5-flash",modified_at:(new Date).toISOString()}],source:"gemini"})}const ollamaUrl="http://localhost:11434/api/tags";try{const response=await fetch(ollamaUrl,{method:"GET"});if(response.ok){const data=await response.json();res.json({status:"connected",models:data.models||[]})}else{res.json({status:"error",message:"Ollama responded but with error"})}}catch(error){res.json({status:"disconnected",message:error.message})}});app.post("/api/upload-file",upload.single("file"),async(req,res)=>{if(!req.file){return res.status(400).json({error:"No file uploaded, brah"})}try{const fileId=Date.now().toString();const fileType=req.file.mimetype;let extractedContent="";if(fileType==="application/pdf"||req.file.originalname.endsWith(".pdf")){extractedContent=await parsePdfContent(req.file.buffer)}else if(fileType==="application/vnd.openxmlformats-officedocument.wordprocessingml.document"||req.file.originalname.endsWith(".docx")){extractedContent=await parseDocxContent(req.file.buffer)}else if(fileType==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"||fileType==="application/vnd.ms-excel"||req.file.originalname.endsWith(".xlsx")||req.file.originalname.endsWith(".xls")){extractedContent=await parseExcelContent(req.file.buffer)}else{extractedContent=await req.file.buffer.toString("utf-8").catch(()=>"[Binary file]")}const tokenCount=estimateTokens(extractedContent);const isLarge=tokenCount>settings.contextWindow*.8;fileStorage.set(fileId,{name:req.file.originalname,buffer:req.file.buffer,mimetype:fileType,content:extractedContent,tokenCount:tokenCount,isLarge:isLarge});res.json({success:true,fileId:fileId,fileName:req.file.originalname,size:req.file.buffer.length,type:fileType,content:extractedContent,tokenCount:tokenCount,isLarge:isLarge,warning:isLarge?`‚ö†Ô∏è This file is ~${tokenCount} tokens (80%+ of context window). Consider splitting it.`:null})}catch(error){console.error("File upload error:",error);res.status(500).json({error:`Failed to upload file: ${error.message}`})}});app.post("/api/delete-file/:fileId",(req,res)=>{const deleted=fileStorage.delete(req.params.fileId);res.json({success:deleted})});app.get("/api/file/:fileId",(req,res)=>{const file=fileStorage.get(req.params.fileId);if(!file){return res.status(404).json({error:"File not found"})}if(file.mimetype==="application/pdf"){res.contentType("application/pdf");res.send(file.buffer)}else if(file.mimetype==="application/vnd.openxmlformats-officedocument.wordprocessingml.document"||file.mimetype.includes("word")){res.contentType("application/vnd.openxmlformats-officedocument.wordprocessingml.document");res.send(file.buffer)}else if(file.mimetype==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"||file.mimetype==="application/vnd.ms-excel"||file.mimetype.includes("sheet")||file.mimetype.includes("excel")){res.contentType("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");res.send(file.buffer)}else{res.contentType("text/plain; charset=utf-8");res.send(file.content)}});app.post("/api/read-file",async(req,res)=>{const{path:filePath}=req.body;if(!filePath){return res.status(400).json({error:"File path required"})}try{const absolutePath=path.isAbsolute(filePath)?filePath:path.join(process.cwd(),filePath);const content=await fs.readFile(absolutePath,"utf-8");res.json({success:true,path:filePath,content:content})}catch(error){console.error("[MAGNUS] Failed to read file:",error);res.status(500).json({error:`Failed to read file: ${error.message}`})}});app.post("/api/websearch",async(req,res)=>{const{query:query}=req.body;if(!query||query.trim()===""){return res.status(400).json({error:"Search query required"})}if(!webSearch.isConfigured()){return res.status(503).json({error:"Web search not configured. Set BRAVE_API_KEY or GOOGLE_API_KEY env vars."})}try{const results=await webSearch.search(query);res.json({success:true,query:query,results:results})}catch(error){console.error("Web search error:",error);res.status(500).json({error:`Search failed: ${error.message}`})}});app.post("/api/memory/add",(req,res)=>{const{role:role,content:content,metadata:metadata}=req.body;if(!role||!content){return res.status(400).json({error:"role and content required"})}activeMemory.addMessage(role,content,metadata||{});res.json({success:true,count:activeMemory.getMessageCount()})});app.get("/api/memory/history",(req,res)=>{const limit=req.query.limit?parseInt(req.query.limit):null;const history=activeMemory.getRawHistory(limit);res.json({history:history,count:history.length})});app.post("/api/memory/clear",(req,res)=>{activeMemory.clearHistory();res.json({success:true})});app.get("/api/memory/status",(req,res)=>{res.json({messageCount:activeMemory.getMessageCount(),config:{maxHistoryMessages:memoryConfig.maxHistoryMessages,contextTurns:memoryConfig.contextTurns}})});app.post("/api/ollama-chat",async(req,res)=>{const{messages:messages,includeMemory:includeMemory=true,attachments:attachments=[]}=req.body;if(!messages||messages.length===0){return res.status(400).json({error:"No messages provided"})}const lastUserMessage=messages[messages.length-1];if(lastUserMessage&&lastUserMessage.role==="user"){const userMetadata={source:"user",timestamp:(new Date).toISOString()};if(attachments&&attachments.length>0){userMetadata.attachments=attachments.map(att=>({fileId:att.fileId,fileName:att.fileName,type:att.type,tokenCount:att.tokenCount}))}activeMemory.addMessage("user",lastUserMessage.content,userMetadata)}let messagesArray=[];let systemInstruction=settings.systemPrompt;if(includeMemory&&messages.length>0){const lastUserMessageContent=messages[messages.length-1]?.content||"";const memoryContext=activeMemory.buildContextString(lastUserMessageContent,fileStorage);if(memoryContext){const enhancedMessage={...messages[messages.length-1],content:memoryContext+messages[messages.length-1].content};messagesArray.push(...messages.slice(0,-1),enhancedMessage)}else{messagesArray.push(...messages)}}else{messagesArray.push(...messages)}console.log("DEBUG: Checking GEMINI_API_KEY in request:",!!process.env.GEMINI_API_KEY);if(process.env.GEMINI_API_KEY&&process.env.GEMINI_API_KEY.trim()!==""){console.log(`‚ú® Using Gemini API (Model: gemini-1.5-flash)`);try{console.log(`[GEMINI] üöÄ Initializing client...`);const client=new GoogleGenAI({apiKey:process.env.GEMINI_API_KEY});let finalMessagesArray=[...messagesArray];if(attachments&&attachments.length>0){console.log("[GEMINI ATTACH DEBUG] Processing",attachments.length,"attachments");const lastMsgIndex=finalMessagesArray.length-1;if(lastMsgIndex>=0&&finalMessagesArray[lastMsgIndex].role==="user"){let attachmentText="";attachments.forEach(att=>{console.log("[GEMINI ATTACH DEBUG] Processing attachment:",att.fileName,"fileId:",att.fileId);const file=fileStorage.get(att.fileId);if(file&&file.content){console.log("[GEMINI ATTACH DEBUG] File found in storage. Content length:",file.content.length);console.log("[GEMINI ATTACH DEBUG] First 200 chars:",file.content.substring(0,200));attachmentText+=`\n\n--- ATTACHMENT: ${file.name} ---\n`;attachmentText+=file.content;attachmentText+=`\n--- END OF ${file.name} ---\n`}else{console.log("[GEMINI ATTACH DEBUG] File NOT found in storage or has no content!")}});if(attachmentText){console.log("[GEMINI ATTACH DEBUG] Total attachment text length:",attachmentText.length);finalMessagesArray[lastMsgIndex]={...finalMessagesArray[lastMsgIndex],content:finalMessagesArray[lastMsgIndex].content+attachmentText};console.log("[GEMINI ATTACH DEBUG] Final message content length:",finalMessagesArray[lastMsgIndex].content.length)}}}const geminiContents=finalMessagesArray.map(msg=>{let role="user";if(msg.role==="assistant")role="model";if(msg.role==="system")return null;return{role:role,parts:[{text:msg.content}]}}).filter(Boolean);console.log(`[GEMINI] üì® Sending request to gemini-2.5-flash...`);const streamResult=await client.models.generateContentStream({model:"gemini-2.5-flash",contents:geminiContents,config:{systemInstruction:{parts:[{text:systemInstruction}]},maxOutputTokens:settings.contextWindow}});console.log(`[GEMINI] üì° Stream started...`);res.setHeader("Content-Type","text/event-stream");res.setHeader("Cache-Control","no-cache");res.setHeader("Connection","keep-alive");let fullResponse="";for await(const chunk of streamResult){const chunkText=chunk.candidates?.[0]?.content?.parts?.[0]?.text||"";if(!chunkText)continue;fullResponse+=chunkText;const ollamaChunk={model:"gemini-2.5-flash",created_at:(new Date).toISOString(),message:{role:"assistant",content:chunkText},done:false};res.write(`data: ${JSON.stringify(ollamaChunk)}\n\n`)}const doneChunk={model:"gemini-2.5-flash",created_at:(new Date).toISOString(),message:{role:"assistant",content:""},done:true};res.write(`data: ${JSON.stringify(doneChunk)}\n\n`);res.write("data: [DONE]\n\n");res.end();if(fullResponse.trim()){activeMemory.addMessage("assistant",fullResponse,{source:"gemini"})}}catch(error){console.error("Gemini call failed:",error);res.write(`data: ${JSON.stringify({error:`Gemini Error: ${error.message}`})}\n\n`);res.end()}return}const ollamaUrl="http://localhost:11434/api/chat";console.log(`ü§ñ Ollama chat with model: ${settings.model}`);try{let ollamaMessages=[];if(systemInstruction&&systemInstruction.trim()){ollamaMessages.push({role:"system",content:systemInstruction})}ollamaMessages.push(...messagesArray);const response=await fetch(ollamaUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:settings.model,messages:ollamaMessages,stream:true,options:{num_ctx:settings.contextWindow}})});if(!response.ok){const errText=await response.text();throw new Error(`Ollama's having a moment: ${response.status} - ${errText}`)}res.setHeader("Content-Type","text/event-stream");res.setHeader("Cache-Control","no-cache");res.setHeader("Connection","keep-alive");const reader=response.body.getReader();const decoder=new TextDecoder;let fullResponse="";try{while(true){const{done:done,value:value}=await reader.read();if(done)break;const chunk=decoder.decode(value);res.write(`data: ${chunk}\n\n`);try{const lines=chunk.split("\n");for(const line of lines){if(line.trim()){const parsed=JSON.parse(line);if(parsed.message?.content){fullResponse+=parsed.message.content}}}}catch(e){}}res.write("data: [DONE]\n\n");res.end();if(fullResponse.trim()){activeMemory.addMessage("assistant",fullResponse,{source:"ollama"})}}catch(err){console.error("Stream error:",err);res.write(`data: ${JSON.stringify({error:err.message})}\n\n`);res.end()}}catch(error){console.error("Ollama call failed:",error);res.status(500).json({error:`Failed to talk to Ollama. Is it running, my dude? ${error.message}`})}});app.post("/api/apply-patch",(req,res)=>{try{const{originalContent:originalContent,change:change}=req.body;if(typeof originalContent==="undefined"||!change){return res.status(400).json({error:"Missing originalContent or change object in request."})}const injector=new SmartInjector;const patchedContent=injector.apply(originalContent,change);console.log("[MAGNUS] ‚úì Patch applied successfully");res.json({patchedContent:patchedContent})}catch(error){console.error("[MAGNUS] ‚úó Smart Injector error:",error);res.status(500).json({error:`Failed to apply patch: ${error.message}`})}});app.get("/",(req,res)=>{res.sendFile(path.join(__dirname,"app","app.html"))});app.use(express.static(path.join(__dirname,"app")));const puppeteer=require("puppeteer");let browser;const server=app.listen(PORT,async()=>{console.log(`\n   __  ______  ______  ____  ______\n  /  |/  / _ |/ ___/ |/ / / / / __/\n / /|_/ / __ / (_ /    / /_/ /\\ \\  \n/_/  /_/_/ |_\\___/_/|_/\\_____/___/  \n\nMagnus's Gnarly Code Editor is ON! üî•\nhttp://localhost:${PORT}\n\nMemory:         ${activeMemory.getMessageCount()} messages stored\nWeb Search:     ${webSearch.isConfigured()?"‚úì Ready":"‚úó Not configured"}\nSmart Injector: ‚úì Armed and Ready\n`);try{browser=await puppeteer.launch({headless:false,args:[`--app=http://localhost:${PORT}`,"--window-size=1280,800"]});browser.on("disconnected",()=>{console.log("\nüëã Shutting down Magnus... Later, brah!");process.emit("SIGINT")})}catch(error){console.error("Could not launch browser, something is cooked:",error);process.exit(1)}});process.on("SIGINT",async()=>{console.log("\nüëã Shutting down Magnus...");if(browser){await browser.close()}activeMemory.close();server.close(()=>{process.exit(0)})});